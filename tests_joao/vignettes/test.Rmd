---
title: 'gtfs2gps: Converting GTFS data to GPS format'
author: "Rafael H. M. Pereira, Pedro R. Andrade, Joao Bazzo"
date: "`r format('25 November 2019')`"
urlcolor: blue
output:
  pdf_document:
    fig_caption: yes
    latex_engine: pdflatex
  html_document:
    df_print: paged
abstract: Package `gtfs2gps` has a set of functions to convert GTFS data to GPS format using `data.table`. It also has some functions to subset GTFS data in time and space and to convert both representations to simple feature format.
vignette: |
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{colrow: Handling SimU, CR, and LU datas}
---

# Introduction 

Package `gtfs2gps` allows users to handle and converting GTFS data using `data.table` format. Before using the package, just install it from GitHub.

```{r, eval = FALSE}
devtools::install_github("ipeaGIT/gtfs2gps")
```

# Loading data

After loading the package, GTFS data can be read into R by using `read_gtfs()`.
This function gets a zipped GTFS file and returns a list of `data.table` objects. The returning list contains the data of each GTFS file indexed according to their file names without extension.

```{r}
library("gtfs2gps")
sp <- read_gtfs(system.file("extdata/saopaulo.zip", package="gtfs2gps"))
names(sp)
sp$trips
```

Note that not all GTFS files are loaded into R. This function loads only the necessary data to spatially and temporally handle trips and stops, which are:
agency.txt, calendar.txt, routes.txt, shapes.txt, 
stop_times.txt, stops.txt, trips.txt, and frequencies.txt (this last one is optional).
If a given GTFS zipped file does not contain all the required files then `read_gtfs()` will stop with an error.

# Simplifying Data

As GTFS data are usually very big, any exploratory analysis has to firstly subset it in order to speedup the process. There are some functions to filter a GTFS data:

\begin{description}
\item[filter\_by\_shape\_id():] Filter shapes using given shape ids.
\item[filter\_valid\_stop\_times():] Return only stop times that have geospatial locations.
\item[filter\_week\_days():] Remove weekend trips.
\item[filter\_single\_trip():] Return only one trip per shape\_id.
\end{description}

These functions subset all the relevant GTFS files in order to remove all the unnecessary rows, keeping the data consistent. The returning values of the four functions is a list of `data.table` objects, in the same way of the input data. For example, in the code below we filter only shape ids between 53000 and 53020.

```{r}
library(magrittr)

object.size(sp) %>% format(units = "Kb")

sp_small <- gtfs2gps::filter_by_shape_id(sp, 53000:53020)

object.size(sp_small) %>% format(units = "Kb")
```

We can then convert both data to simple feature format and plot them.
